---
title: JavaScriptä¸­çš„å¼‚æ­¥ç¼–ç¨‹
date: 2019-11-07
lang: zh-CN
display: home
tags:
  - JavaScript
categorise:
  - Blog
---

JavaScriptä¸­çš„å¼‚æ­¥ç¼–ç¨‹ ---- Promise

<!-- more -->

  äº†è§£JavaScriptçš„å¼‚æ­¥ç¼–ç¨‹ä¹‹å‰éœ€è¦å…ˆå­¦ä¹ [JavaScriptçš„æœ‰å…³è¿è¡Œæœºåˆ¶](https://blog.webhbz.com/Pages/eventloop.html)
ä¸ºäº†åœ¨æ•´ä½“ä¸Šæœ‰ä¸ªå……åˆ†çš„è®¤è¯†ï¼Œå¯ä»¥å…ˆé˜…è¯»ä¸€ä¸‹çŸ¥ä¹ä¸Šçš„è¿™ç¯‡[æ–‡ç« ](https://zhuanlan.zhihu.com/p/66593213)ï¼Œç›¸å¯¹ç®€å•ä¾¿äºç†è§£ã€‚

## ä»€ä¹ˆæ˜¯Promise

  Promiseæœ€æ—©ç”±ç¤¾åŒºæå‡ºï¼Œæ˜¯ç”¨æ¥è§£å†³å›è°ƒåœ°ç‹±çš„æ–¹æ¡ˆï¼ŒES6 å°†å…¶å†™è¿›äº†è¯­è¨€æ ‡å‡†ï¼Œç»Ÿä¸€äº†ç”¨æ³•ï¼ŒåŸç”Ÿæä¾›äº†`Promise`å¯¹è±¡ã€‚
> æ‰€è°“çš„`Promise`ï¼Œç®€å•è¯´å°±æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œé‡Œé¢ä¿å­˜ç€æŸä¸ªæœªæ¥æ‰ä¼šç»“æŸçš„äº‹ä»¶ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼‰çš„ç»“æœã€‚ä»è¯­æ³•ä¸Šè¯´ï¼ŒPromise æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä»å®ƒå¯ä»¥è·å–å¼‚æ­¥æ“ä½œçš„æ¶ˆæ¯ã€‚Promise æä¾›ç»Ÿä¸€çš„ APIï¼Œå„ç§å¼‚æ­¥æ“ä½œéƒ½å¯ä»¥ç”¨åŒæ ·çš„æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚   ---- ã€ŠECMAScript 6 å…¥é—¨ã€‹

Promiseå¯¹è±¡åœ¨åˆ›å»ºåï¼Œå°±ä¼šåˆ›å»ºå†…éƒ¨çŠ¶æ€æœºï¼ŒPromiseå¯¹è±¡ä»£è¡¨äº†ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œè€ŒçŠ¶æ€æœºå°±åŒ…å«äº†è¿™ä¸ªå¼‚æ­¥æ“ä½œçš„çŠ¶æ€ï¼Œ`pendding`ï¼Œ`fulfilled`ï¼Œ`rejected`ï¼Œ
åœ¨`Promise`å¯¹è±¡ä¸­ï¼Œåªä¼šå­˜åœ¨ä¸Šè¿°ä¸‰ç§çŠ¶æ€ä¸­çš„ä¸€ç§ï¼Œä¸”ä¸ºä¸å¯é€†çš„ï¼Œä¸å—å¤–ç•Œå½±å“ã€‚

## åˆ›å»ºä»¥åŠä½¿ç”¨Promise
åœ¨ES6ä¸­æœ‰åŸç”Ÿçš„Promiseæ„é€ å‡½æ•°ï¼Œä½¿ç”¨å…³é”®å­—`new` æ¥åˆ›å»ºä¸€ä¸ª`Promise`å¯¹è±¡ã€‚

```JavaScript
const promise = new Promise ((resolve,reject) => { // æ„é€ å‡½æ•°æ¥å—ä¸€ä¸ªå‡½æ•°ä¸ºå‚æ•°ï¼Œå°†è¿™ä¸ªå‚æ•°æš‚åä¸º'fn' ï¼Œ'fn'åˆæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸”å‡ä¸ºå‡½æ•°
  const flag = Math.random() > .5 ? true : false ;
  if(flag) {
    console.log('ä½¿ç”¨resolveå°†promiseçŠ¶æ€ä»pendingå˜ä¸ºresolved');
    resolve('å¤§äº0.5')
  } else {
    console.log('ä½¿ç”¨rejectå°†promiseçŠ¶æ€ä»pendingå˜ä¸ºrejected')
    reject('å°äº0.5')
  }
})


promise.then((resolve) => {
  console.log(resolve)  // -- 'å¤§äº0.5'
},(reject) => {
  console.log(reject)  // -- 'å°äº0.5'
})

```
æˆ‘ä»¬æ¥ä¸€ç‚¹ç‚¹æ‹†åˆ†è¿™ä¸ª`Promise`ï¼Œå¥¹æ¥æ”¶äº†ä¸€ä¸ªå‡½æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°åˆæœ‰ä¸¤ä¸ªå‚æ•°`resolve`ï¼Œ`reject`ï¼Œè¿™ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯Promiseä¸ºæˆ‘ä»¬åˆ›å»ºå¥½çš„`å‡½æ•°`ã€‚è¿™ä¸¤ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯å°†`Promise`çš„çŠ¶æ€ä»`pending`ï¼ˆç­‰å¾…ï¼‰è½¬æ¢ä¸º`resolved`ï¼ˆå·²è§£å†³ï¼‰æˆ–è€…ä»`pending`ï¼ˆç­‰å¾…ï¼‰è½¬æ¢ä¸º`rejected`ï¼ˆå·²å¤±è´¥ï¼‰ã€‚
è€Œåœ¨Promiseåˆ›å»ºåï¼Œæœ‰ä¸€äº›è‡ªèº«çš„æ–¹æ³•ã€‚è¿™é‡Œå…ˆåªè¯´`then`ï¼Œè¯¥æ–¹æ³•æ¥å—ä¸¤ä¸ª`å‡½æ•°`ä½œä¸ºå‚æ•°ï¼Œè¿™é‡Œå°±å’Œä¸Šé¢ä¼ å…¥Promiseçš„æ„é€ å‡½æ•°ä¸­çš„å‚æ•°å‡½æ•°ï¼ˆ`fn`ï¼‰çš„ä¸¤ä¸ªå‚æ•°ï¼ˆ`resolve`,`reject`ï¼‰å¯¹åº”ä¸Šäº†ã€‚å¾ˆæ˜¾ç„¶ï¼Œ`then`æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°å‡½æ•°ï¼Œæ¥æ”¶åˆ°`resolve`ä¼ é€’å‡ºçš„æ•°æ®ï¼Œè€Œç¬¬äºŒä¸ªå‚æ•°å°±æ¥æ”¶åˆ°äº†`reject`ä¼ é€’å‡ºçš„æ•°æ®ã€‚
é‚£ä¹ˆ`Promise`æ˜¯æ€ä¹ˆè§£å†³å¼‚æ­¥æ“ä½œçš„å›è°ƒåœ°ç‹±å‘¢ï¼Ÿç®€å•çš„è¯´å°±æ˜¯ç”¨`Promsie`å¯¹è±¡åŒ…è£¹ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œå¼‚æ­¥æ“ä½œåªåœ¨`Promise`å¯¹è±¡å†…éƒ¨ï¼Œä¸å—å¤–éƒ¨å½±å“åŒæ—¶ä¹Ÿä¸é˜»å¡å¤–éƒ¨ï¼Œåœ¨è¿™ä¸ªå¼‚æ­¥æ“ä½œæœ‰äº†ç»“æœåï¼Œé€šè¿‡`then`æ–¹æ³•å’Œå¤–éƒ¨è¿›è¡Œæ•°æ®ä¼ é€’ã€‚å¦‚ä¸‹ï¼š

```JavaScript
const promise = new Promise((resolve, reject) => {
    setTimeout(() => {
        Math.random() > 0.5 ? resolve('success') : reject('fail');
    }, 1000)
});


promise.then((result) => {
    console.log(result);
}, (err) => {
    console.log(err);
});

```
è¿™é‡Œçš„`setTimeout`å°±æ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œåœ¨1ç§’åå¾—åˆ°ç»“æœã€‚è‹¥å¤§äº0.5çš„è¯ï¼Œ`resolve`å°±ä¼šæ‰§è¡Œï¼Œåˆ™`Promise`çš„çŠ¶æ€ä»`pending`å˜ä¸º`fulfilled`ï¼Œå¦åˆ™å˜ä¸º`rejected`ï¼Œå¼‚æ­¥æ“ä½œä¸­çš„æ•°æ®(â€˜successâ€™æˆ–â€˜failâ€™)ä¼šé€šè¿‡å‡½æ•°ä¼ é€’åˆ°`Promise`å¤–éƒ¨ï¼Œæˆ‘ä»¬é€šè¿‡`then`è·å–åˆ°è¯¥æ•°æ®.
é‚£ä¹ˆç®€å•çš„`Promise`å¯¹è±¡æˆ‘ä»¬å·²ç»äº†è§£äº†,ä½†æ˜¯ä»–æ˜¯æ€ä¹ˆæ¥è§£å†³å›ç­”åœ°ç‹±çš„å‘¢?å…¶å®å¾ˆç®€å•,å› ä¸º`then`æ–¹æ³•ä¼š`return`ä¸€ä¸ª`Promise`å¯¹è±¡æ¥ä¾›æˆ‘ä»¬ä½¿ç”¨.åŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨åˆ›å»ºæ–°çš„`Promise`å¯¹è±¡.
ä¸¾ä¸ªğŸŒ°

```js
const pm1 = new Promise((resolve,reject) => {
  resolve('å‡è£…è¿™æ˜¯å¼‚æ­¥æ“ä½œçš„æˆåŠŸçš„ç»“æœ')
});

// @1 ä½¿ç”¨return é»˜è®¤çš„Promiseå¯¹è±¡
pm1.then(result => {
  console.log('æ¥æ”¶Promiseä¼ å‡ºçš„:', result);
  return 'æˆ‘æ˜¯è¢«then returnå‡ºæ¥çš„';
}).then(result => {
  console.log("æ¥æ”¶ä¸Šä¸€ä¸ªthen:", result)
  return "æˆ‘è¿˜æ˜¯è¢«then returnå‡ºæ¥çš„";
}).then(result => {
  console.log('æ¥æ”¶ä¸Šä¸€ä¸ªthen:', result)
});

---æ§åˆ¶å°æ‰“å°å¦‚ä¸‹
æ¥æ”¶Promiseä¼ å‡ºçš„: å‡è£…è¿™æ˜¯å¼‚æ­¥æ“ä½œçš„æˆåŠŸçš„ç»“æœ
æ¥æ”¶ä¸Šä¸€ä¸ªthen: æˆ‘æ˜¯è¢«then returnå‡ºæ¥çš„
æ¥æ”¶ä¸Šä¸€ä¸ªthen: æˆ‘è¿˜æ˜¯è¢«then returnå‡ºæ¥çš„
PromiseÂ {<resolved>: undefined}
---

// @2 æ‰‹åŠ¨åˆ›å»ºPromise
pm1.then(result => {
  console.log("pm1å¼‚æ­¥:",result);
  const pm2 = new Promise((resolve,reject) => {
    setTimeout(() => {
      resolve('pm2å¼‚æ­¥æ“ä½œæˆåŠŸçš„ç»“æœ')
    },2000)
  });
  return pm2;
}).then(result2 => {
  console.log("pm2å¼‚æ­¥:",result2)
})

--- æ§åˆ¶å°æ‰“å°å¦‚ä¸‹
pm1å¼‚æ­¥: å‡è£…è¿™æ˜¯å¼‚æ­¥æ“ä½œçš„æˆåŠŸçš„ç»“æœ
PromiseÂ {<pending>}
// 2så
pm2å¼‚æ­¥: pm2å¼‚æ­¥æ“ä½œæˆåŠŸçš„ç»“æœ
---
```
è¿™å°±æ˜¯å¸¸è§çš„`Promis`çš„é“¾å¼è°ƒç”¨,å…¶å®`Promise`å°±æ˜¯åŸç”Ÿå°è£…çš„ä¸€ä¸ªå¯¹è±¡,çº¦å®šåˆ›å»ºæ˜¯ä¼ å…¥ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«åœ¨æˆåŠŸå’Œå¤±è´¥åè°ƒç”¨,åˆåœ¨`then`çš„ä¸¤å‚æ•°(å‡ä¸ºå‡½æ•°)ä¸­è·å–.ä¸‹é¢ç®€å•ä»‹ç»ä¸€ä¸‹`catch`å’Œå…¶ä»–åŸç”Ÿæ–¹æ³•çš„ä½¿ç”¨åœºæ™¯.

### catch
ä¸€å¥è¯æ¥è§£é‡Š,`catch` === `then(null,reject)`.
`catch`æ˜¯ç”¨æ¥æ•æ‰`Promis`ä¸­çš„å¼‚å¸¸,ä¹Ÿå°±æ˜¯å¤±è´¥åä¼ é€’å‡ºçš„ä¿¡æ¯.`then`æ˜¯å¯ä»¥åŒæ—¶æ¥å—å¤±è´¥å’ŒæˆåŠŸå`Promise`ä»å†…éƒ¨ä¼ å‡ºçš„æ•°æ®,ä½†æ˜¯æœªæ¥æ–¹ä¾¿é˜…è¯»å’Œç»´æŠ¤,ä¸€èˆ¬åœ¨`then`ä¸­åªæ‰§è¡ŒæˆåŠŸçš„.æˆ‘ä»¬å°†æ•´ä¸ªè¿‡ç¨‹ä¸­çš„å¼‚å¸¸æ”¾åˆ°æœ€å,é€šè¿‡`catch`æ¥æ•è·.ğŸŒ°:

```js
const pmCatch = new Promise((resolve,reject) => {
  reject('fail')
});

pmCatch.then(result => {
  console.log('this is then');
  const pmCatch2 = new Promise((resolve,reject) => {
    setTimeout(() => {
      resolve('success')
    },2000)
  });
  return pmCatch2;
}).then(res => {
  cpnsole.log('then:', res);
}).catch(err => {
  console.log('catch:', err);
})

---æ§åˆ¶å°æ‰“å°å¦‚ä¸‹
catch: fail
PromiseÂ {<resolved>: undefined}
---

```
çœ‹ä¸‹æ‰“å°ç»“æœ,å¥½åƒè·Ÿæƒ³è±¡ä¸­çš„ä¸å¤ªä¸€æ ·.è¿™é‡Œæ²¡æœ‰æ‰“å°å‡ºâ€˜this is thenâ€™å’Œâ€˜then:successâ€™,è€Œæ˜¯ç›´æ¥æ‰“å°äº†â€˜catch: failâ€™.æ˜æ˜¾çš„åœ¨æ•´ä¸ª`Promise`é“¾ä¸­,åªè¦å‡ºç°äº†`reject`äº†,æ•´ä¸ª`Promise`çš„çŠ¶æ€å°±ä¼šå‡å›ºä¸”ä¸ä¼šå˜åŒ–.å¦å¤–,`then`æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œå¦‚æœè¿è¡Œä¸­æŠ›å‡ºé”™è¯¯ï¼Œä¹Ÿä¼šè¢«`catch`æ–¹æ³•æ•è·ã€‚è€Œä¸”`Promise`å¯¹è±¡å¯¹äºå¼‚å¸¸æœ‰ç±»ä¼¼å†’æ³¡çš„æ€§è´¨,å¼‚å¸¸ä¼šä¸€ç›´å‘åä¼ é€’ï¼Œç›´åˆ°è¢«æ•è·ä¸ºæ­¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé”™è¯¯æ€»æ˜¯ä¼šè¢«ä¸‹ä¸€ä¸ª`catch`è¯­å¥æ•è·ã€‚

### Promise.finally()
`finally`æ–¹æ³•ç”¨äºæŒ‡å®šä¸ç®¡`Promise`å¯¹è±¡æœ€åçŠ¶æ€å¦‚ä½•ï¼Œéƒ½ä¼šæ‰§è¡Œçš„æ“ä½œã€‚è¯¥æ–¹æ³•æ˜¯ ES2018 å¼•å…¥æ ‡å‡†çš„ã€‚
```js

promise
.then(result => {Â·Â·Â·})
.catch(error => {Â·Â·Â·})
.finally(() => {Â·Â·Â·});

```


### Promise.all()
`Promise.all()`æ–¹æ³•ç”¨äºå°†å¤šä¸ª`Promise`å®ä¾‹ï¼ŒåŒ…è£…æˆä¸€ä¸ªæ–°çš„`Promise`å®ä¾‹.
```js
const p = Promise.all([p1, p2, p3]); // p1 p2 p3 å‡ä¸ºPromiseå¯¹è±¡
```
`Promise.all()`æ–¹æ³•çš„å‚æ•°å¯ä»¥ä¸æ˜¯æ•°ç»„ï¼Œä½†å¿…é¡»å…·æœ‰`Iterator`æ¥å£ï¼Œä¸”è¿”å›çš„æ¯ä¸ªæˆå‘˜éƒ½æ˜¯`Promise`å®ä¾‹ã€‚
`p`çš„çŠ¶æ€ç”±`p1`ã€`p2`ã€`p3`å†³å®šï¼Œåˆ†æˆä¸¤ç§æƒ…å†µã€‚
- åªæœ‰`p1`ã€`p2`ã€`p3`çš„çŠ¶æ€éƒ½å˜æˆ`fulfilled`ï¼Œ`p`çš„çŠ¶æ€æ‰ä¼šå˜æˆ`fulfilled`ï¼Œæ­¤æ—¶`p1`ã€`p2`ã€`p3`çš„è¿”å›å€¼ç»„æˆä¸€ä¸ªæ•°ç»„ï¼Œä¼ é€’ç»™`p`çš„å›è°ƒå‡½æ•°ã€‚
- åªè¦`p1`ã€`p2`ã€`p3`ä¹‹ä¸­æœ‰ä¸€ä¸ªè¢«`rejected`ï¼Œ`p`çš„çŠ¶æ€å°±å˜æˆ`rejected`ï¼Œæ­¤æ—¶ç¬¬ä¸€ä¸ªè¢«`reject`çš„å®ä¾‹çš„è¿”å›å€¼ï¼Œä¼šä¼ é€’ç»™`p`çš„å›è°ƒå‡½æ•°ã€‚

ä¸€èˆ¬çš„ä½¿ç”¨åœºæ™¯æ˜¯æ•°æ®åŒæ—¶ä¾èµ–äºå¤šä¸ªè¯·æ±‚çš„è¿”å›å€¼æ—¶.


### Promis.race()
`Promise.race()`æ–¹æ³•åŒæ ·æ˜¯å°†å¤šä¸ª`Promise`å®ä¾‹ï¼ŒåŒ…è£…æˆä¸€ä¸ªæ–°çš„`Promise`å®ä¾‹ã€‚å…¶å‚æ•°æ ¼å¼åŒ`Promise.all()`;
```js
const p = Promise.all([p1, p2, p3]); // p1 p2 p3 å‡ä¸ºPromiseå¯¹è±¡
```
åªè¦`p1`ã€`p2`ã€`p3`ä¹‹ä¸­æœ‰ä¸€ä¸ªå®ä¾‹ç‡å…ˆæ”¹å˜çŠ¶æ€ï¼Œ`p`çš„çŠ¶æ€å°±è·Ÿç€æ”¹å˜ã€‚é‚£ä¸ªç‡å…ˆæ”¹å˜çš„`Promise`å®ä¾‹çš„è¿”å›å€¼ï¼Œå°±ä¼ é€’ç»™`p`çš„å›è°ƒå‡½æ•°ã€‚â€œè¡Œâ€å¦‚å…¶å,ç«è·‘.è°æœ€æ—©è·‘å®Œå¬è°çš„.

### Promise.any()
`Promise.any()`æ–¹æ³•æ¥å—ä¸€ç»„`Promise`å®ä¾‹ä½œä¸ºå‚æ•°ï¼ŒåŒ…è£…æˆä¸€ä¸ªæ–°çš„`Promise`å®ä¾‹ã€‚åªè¦å‚æ•°å®ä¾‹æœ‰ä¸€ä¸ªå˜æˆ`fulfilled`çŠ¶æ€ï¼ŒåŒ…è£…å®ä¾‹å°±ä¼šå˜æˆ`fulfilled`çŠ¶æ€ï¼›å¦‚æœæ‰€æœ‰å‚æ•°å®ä¾‹éƒ½å˜æˆ`rejected`çŠ¶æ€ï¼ŒåŒ…è£…å®ä¾‹å°±ä¼šå˜æˆ`rejected`çŠ¶æ€ã€‚

### å…¶ä»–
å…¶ä»–çš„è¿˜æœ‰`Promise.resolve()`,`Promise.reject()`,ä»¥ä¸Šä¸¤ä¸ªæ–¹æ³•è¯¦æƒ…å‚è€ƒé˜®å¤§çš„[ã€ŠES6å…¥é—¨ã€‹](http://es6.ruanyifeng.com/#docs/promise#Promise-resolve)